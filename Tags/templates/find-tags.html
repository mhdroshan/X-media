{% extends 'base.html' %} {% block title %}X-media | Find{% endblock %}
{% block content %}
<style>
  .navbar-nav #find {
    color: white !important;
  }
   .tag-place-dat{
    position: absolute;
    top: 3px;
    right: 10px;
    font-size: 20px;
  }
  .tag-place-dat i{
    padding-right: 5px;
  }
  .the-tag{
    z-index: 1;
        width: 87%;
        border:2px solid #212121;
    position: relative;
    transition: .3s ease;
    top: 0;
  }
  .tag-place-dat i{
    padding-right: 7px;
  }
  .the-tag:hover{
    border:2px solid white;
  }
  .the-tag-head h2,
  .the-tag-head span{
    font-size: 35px;
  }
  .post-count p{
    font-size: 11px;
  }
  .post-count{
    font-size: 25px;
    bottom: 5px;
  }
  .tag-cov-img{
    width: 100%;
  }
  .tag-place-dat{
    font-size: 15px;
    top: 5px;
  }
  .tag-error{
    margin: 40px auto;
  }
</style>

<div class="search-holder">
  <input
    type="text"
    id="searchinput"
    onkeyup="search()"
    placeholder="Search for tags, countries or users"
    id="search"
  />

  <ul id="searchlist" class="search-cls">
      <!-- country -->
      {% if country %} {% for post in country %}
      {% if not post.tag_id__t_country == "0" %}
      <li>
          <div style="background: #d31a1a;" class="serch-icon">
              <i class="fa fa-map-marker" aria-hidden="true"></i>
          </div>
        <p style="text-transform: capitalize;">{{ post.tag_id__t_country}}</p>
        <p class="post-cc" >{{ post.dcount}}</p>
        <p class="cc-custom" >Posts</p>
        
        <!-- <img
         
          src="{{user.u_pic.url}}"
          alt="user-dp"
          srcset=""
        /> -->
      </li>
      {% endif %}
      {% endfor %} {% endif %}


      <!-- tags -->
    {% if tags %} {% for tag in tags %}
    <a href="{% url 'Posts:related-post' tag.id %}">
    
    <li>
        <div  style="background: #3F51B5;" class="serch-icon">
            <i class="fa fa-tag"  aria-hidden="true"></i>
        </div>
      <p style="text-transform: uppercase;">#{{ tag.tag_name }}</p>
      <p style="font-size: 14px;
      text-align: center;
      position: absolute;
      top: 30px;
      line-height: 0;"><i class="fa fa-map-marker" aria-hidden="true"></i> 
      
{{ tag.t_country|default:'' }}{% if tag.t_country and tag.t_state %}, {% endif %}{{ tag.t_state|default:'' }}{% if tag.t_state and tag.t_place %}, {% endif %}{{ tag.t_place|default:'' }}

      </p>
      <img
       
        src="{{tag.tag_image.url}}"
        alt="tag-image"
        srcset=""
      />
    </li>
    </a>
    {% endfor %} {% endif %}


    <!-- user -->
    {% if user %} {% for user in users %}
    <a href="{% url 'Posts:related-post-user' user.id %}">
    <li>
        <div style="background: #009688;" class="serch-icon">
            <i class="fa fa-user" aria-hidden="true"></i>
        </div>
      <p style="text-transform: capitalize;">{{ user.u_name }}</p>
      <img
       
        src="{{user.u_pic.url}}"
        alt="user-dp"
        srcset=""
      />
    </li>
  </a>
    {% endfor %} {% endif %}
  
  </ul>

</div>

<div id="tags-table-container" style="margin-top: 20px; padding: 15px; background-color: #2E2E2E; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
  <h4 style="color: white; margin-bottom: 15px;">All Created Tags</h4>
  <table style="width: 100%; border-collapse: collapse; color: white; text-align: left;">
    <thead>
      <tr style="background-color: #3C3C3C;">
        <th style="padding: 10px; border: 1px solid #4A4A4A;">Tag Name</th>
        <th style="padding: 10px; border: 1px solid #4A4A4A;">Country</th>
        <th style="padding: 10px; border: 1px solid #4A4A4A;">State</th>
        <th style="padding: 10px; border: 1px solid #4A4A4A;">Place</th>
        <th style="padding: 10px; border: 1px solid #4A4A4A;">Action</th>
      </tr>
    </thead>
    <tbody>
      {% if tags %}
        {% for tag in tags %}
          <tr style="border-bottom: 1px solid #4A4A4A;">
            <td style="padding: 10px; border: 1px solid #4A4A4A;">{{ tag.tag_name }}</td>
            <td style="padding: 10px; border: 1px solid #4A4A4A;">{{ tag.t_country|default:'' }}</td>
            <td style="padding: 10px; border: 1px solid #4A4A4A;">{{ tag.t_state|default:'' }}</td>
            <td style="padding: 10px; border: 1px solid #4A4A4A;">{{ tag.t_place|default:'' }}</td>
            <td style="padding: 10px; border: 1px solid #4A4A4A;">
              <button class="follow-toggle-button" data-tag-id="{{ tag.id }}" style="background: none; border: none; cursor: pointer; color: #4CAF50; font-size: 1.2em;">
                {% if tag.id in followed_tags_ids %}
                  <i class="fa fa-times-circle" aria-hidden="true" style="color: #f44336;"></i>
                {% else %}
                  <i class="fa fa-plus-circle" aria-hidden="true"></i>
                {% endif %}
              </button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5" style="padding: 10px; text-align: center; color: #888;">No tags created yet.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if u_tags %}
<!-- followings tags -->
<h4 class="u-follow-title" id="folltitle">Tags You Follow</h4>
<div class="u-follow-holder">
<div class="row">
  
   
    {% for tag in u_tags  %}
    <div class="col-sm-6">
      <a href="{% url 'Posts:related-post' tag.tag.id %}">
    <div class="the-tag d-flex">
     <div style="background-image: url('{{tag.tag.tag_image.url }}');" class="tag-cov-img">
      <div class="the-tag-head">
        <h2><span>#</span>{{tag.tag.tag_name}} 
        </h2>
  
      </div>
  
      <!-- tag location -->
      {% if tag.tag.t_country != "0" %}
  
      <p class="tag-place-dat">
        <i class="fa fa-map-marker" aria-hidden="true"></i>
        {{tag.tag.t_country}}
      </p>
      {% endif %}
  
  
  
      {% if tag.tag.t_state != "0" %}
  
      <p class="tag-place-dat">
        <i class="fa fa-map-marker" aria-hidden="true"></i>
        {{tag.tag.t_state}}
      </p>
      {% endif %}
  
  
  
      {% if tag.tag.t_place != "0" %}
      <p class="tag-place-dat">
        <i class="fa fa-map-marker" aria-hidden="true"></i>
        {{tag.tag.t_place}}
      </p>
      {% endif %}
  
    <div style="right: 10px;" class="post-count">
      {{tag.follow_count}} <p>Followers</p>
    </div>
   
     
     </div>
     
  </div>
  </a>
    </div>
    {% endfor %}
    
   
</div>
 
  
</div>
{% else %}
    <h3 class="tag-error">No tags</h3>
{% endif %}


<script>
  // Existing search function
  function search() {
    var input, filter, ul, li, a, i;
    input = document.getElementById("searchinput");
    filter = input.value.toUpperCase();
    ul = document.getElementById("searchlist");
    title = document.getElementById("folltitle"); // This might need adjustment if you remove the title conditionally
    li = ul.getElementsByTagName("li");

    if (input.value.length == 0) {
      ul.style.display = "none";
      if (title) title.style.opacity = "1"; // Only try to set opacity if title exists
      return;
    } else {
      ul.style.display = "block";
      if (title) title.style.opacity = "0"; // Only try to set opacity if title exists
    }
    // Loop through all list items, and hide those who don't match the search query
    for (i = 0; i < li.length; i++) {
      a = li[i].getElementsByTagName("p")[0];
      if (a.innerHTML.toUpperCase().indexOf(filter) > -1) {
        li[i].style.display = "block";
      } else {
        li[i].style.display = "none";
      }
    }
  }

  // New JavaScript for follow/unfollow button
  $(document).ready(function() {
    $('.follow-toggle-button').on('click', function(e) {
      e.preventDefault(); // Prevent default link behavior if button is inside an <a>
      const button = $(this);
      const tagId = button.data('tag-id');
      const csrfToken = $('input[name=csrfmiddlewaretoken]').val();

      $.ajax({
        url: '{% url "Tags:follow_toggle" %}', // This URL needs to be defined in Tags/urls.py
        type: 'POST',
        data: {
          'tag_id': tagId,
          'csrfmiddlewaretoken': csrfToken,
        },
        success: function(response) {
          if (response.success) {
            if (response.is_followed) {
              button.html('<i class="fa fa-times-circle" aria-hidden="true" style="color: #f44336;"></i>');
              // Optionally update follower count or refresh part of the page
            } else {
              button.html('<i class="fa fa-plus-circle" aria-hidden="true"></i>');
              // Optionally update follower count or refresh part of the page
            }
            alert(response.message); // Show a success message
          } else {
            alert('Error: ' + response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX Error:', status, error);
          alert('An error occurred. Please try again.');
        }
      });
    });
  });
</script>

{% endblock content %}
